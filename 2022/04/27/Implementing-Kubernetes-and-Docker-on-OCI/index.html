<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Implementing Kubernetes and Docker on OCI | WuDiaries</title><meta name="author" content="Mr.Kelvin"><meta name="copyright" content="Mr.Kelvin"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="IntroductionThis was an assignment for Cloud Security class in semester 1, 2022. The requirements asked me to pack a web application into Docker and then deploy the service on the cloud using Kubernet">
<meta property="og:type" content="article">
<meta property="og:title" content="Implementing Kubernetes and Docker on OCI">
<meta property="og:url" content="https://wudiaries.com/2022/04/27/Implementing-Kubernetes-and-Docker-on-OCI/">
<meta property="og:site_name" content="WuDiaries">
<meta property="og:description" content="IntroductionThis was an assignment for Cloud Security class in semester 1, 2022. The requirements asked me to pack a web application into Docker and then deploy the service on the cloud using Kubernet">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://hcljapan.co.jp/software/blog/bl-content/uploads/pages/8d736f3963252b65f6c5b49336c4f217/Untitled-1.jpg">
<meta property="article:published_time" content="2022-04-27T00:34:37.000Z">
<meta property="article:modified_time" content="2023-03-04T02:25:03.689Z">
<meta property="article:author" content="Mr.Kelvin">
<meta property="article:tag" content="OCI">
<meta property="article:tag" content="Docker">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="NodePort">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hcljapan.co.jp/software/blog/bl-content/uploads/pages/8d736f3963252b65f6c5b49336c4f217/Untitled-1.jpg"><link rel="shortcut icon" href="/statics/images/favicon.png"><link rel="canonical" href="https://wudiaries.com/2022/04/27/Implementing-Kubernetes-and-Docker-on-OCI/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":50,"languages":{"author":"Author: Mr.Kelvin","link":"Link: ","source":"Source: WuDiaries","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Implementing Kubernetes and Docker on OCI',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '03-04-2023 13:25:03'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = url => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      link.onload = () => resolve()
      link.onerror = () => reject()
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (false) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/statics/images/avatar.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">2</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">2</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://hcljapan.co.jp/software/blog/bl-content/uploads/pages/8d736f3963252b65f6c5b49336c4f217/Untitled-1.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="WuDiaries"><span class="site-name">WuDiaries</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Implementing Kubernetes and Docker on OCI</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-04-27T00:34:37.000Z" title="Created 04-27-2022 10:34:37">04-27-2022</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-03-04T02:25:03.689Z" title="Updated 03-04-2023 13:25:03">03-04-2023</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/DevSecOps/">DevSecOps</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>6min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Implementing Kubernetes and Docker on OCI"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>This was an assignment for Cloud Security class in semester 1, 2022. The requirements asked me to pack a web application into Docker and then deploy the service on the cloud using Kubernetes. The entire lab environment was built on OCI (Oracle Cloud Infrastructure). Here are my configuration notes and the pitfalls I stepped through to help take the easy way out when deploying services to OCI in the future.</p>
<p>This diary focuses on the deployment phase. Since OCI has some pre-defined iptables rules that can block communications between nodes, security lists also affect internal communication between VMs, even if they are in the same subnet. I needed to modify the iptables and security lists as below:</p>
<h1 id="Pre-Configuration"><a href="#Pre-Configuration" class="headerlink" title="Pre-Configuration"></a>Pre-Configuration</h1><h2 id="iptables-controller-amp-nodes"><a href="#iptables-controller-amp-nodes" class="headerlink" title="iptables (controller &amp; nodes)"></a>iptables (controller &amp; nodes)</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">## save existing rules</span><br><span class="line">sudo iptables-save &gt; ~/iptables-rules</span><br><span class="line"></span><br><span class="line">## modify rules, remove drop and reject lines</span><br><span class="line">grep -v &quot;DROP&quot; iptables-rules &gt; tmpfile &amp;&amp; mv tmpfile iptables-rules-mod</span><br><span class="line">grep -v &quot;REJECT&quot; iptables-rules-mod &gt; tmpfile &amp;&amp; mv tmpfile iptables-rules-mod</span><br><span class="line"></span><br><span class="line">## apply the modifications</span><br><span class="line">sudo iptables-restore &lt; ~/iwptables-rules-mod</span><br><span class="line"></span><br><span class="line">## check</span><br><span class="line">sudo iptables -L</span><br><span class="line"></span><br><span class="line">## save the changes</span><br><span class="line">sudo netfilter-persistent save</span><br><span class="line">sudo systemctl restart iptables</span><br><span class="line"></span><br><span class="line">## letting iptables see bridged traffic</span><br><span class="line">cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf</span><br><span class="line">br_netfilter</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sudo sysctl --system</span><br></pre></td></tr></table></figure>

<h2 id="Security-Lists"><a href="#Security-Lists" class="headerlink" title="Security Lists"></a>Security Lists</h2><p>For easy configuration, I opened everything, so security lists ended up with only three rules:</p>
<ul>
<li><code>0.0.0.0/0; TCP; All ports</code></li>
<li><code>0.0.0.0/0; UDP; All ports</code></li>
<li><code>0.0.0.0/0; ICMP</code></li>
</ul>
<p>But make sure that you refer to <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/ports-and-protocols/">Kubernetes documentation</a> and related CNI documentation to narrow down the open ports and IP ranges after implementation.</p>
<h1 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h1><p>After the pre-configuration part, we can start installing Kubernetes and Docker on all the VMs.</p>
<h2 id="System-updates-controller-amp-nodes"><a href="#System-updates-controller-amp-nodes" class="headerlink" title="System updates (controller &amp; nodes)"></a>System updates (controller &amp; nodes)</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt update</span><br></pre></td></tr></table></figure>

<h2 id="Docker-controller-amp-nodes"><a href="#Docker-controller-amp-nodes" class="headerlink" title="Docker (controller &amp; nodes)"></a>Docker (controller &amp; nodes)</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt -y install docker.io</span><br><span class="line">sudo nano /etc/docker/daemon.json</span><br></pre></td></tr></table></figure>

<p>In <code>daemon.json</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then run</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>

<p>To check if Cgroup is <code>systemd</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker info | grep group</span><br></pre></td></tr></table></figure>

<h2 id="K8S-Installation-controller-amp-nodes"><a href="#K8S-Installation-controller-amp-nodes" class="headerlink" title="K8S Installation (controller &amp; nodes)"></a>K8S Installation (controller &amp; nodes)</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">curl -s &lt;https://packages.cloud.google.com/apt/doc/apt-key.gpg&gt; | sudo apt-key add</span><br><span class="line">sudo apt-add-repository &quot;deb &lt;http://apt.kubernetes.io/&gt; kubernetes-xenial main&quot;</span><br><span class="line">sudo apt-get -y install kubeadm kubelet kubectl</span><br><span class="line">sudo apt-mark hold kubeadm kubelet kubectl</span><br></pre></td></tr></table></figure>

<h1 id="Post-Configuration"><a href="#Post-Configuration" class="headerlink" title="Post-Configuration"></a>Post-Configuration</h1><h2 id="K8S-init-controller"><a href="#K8S-init-controller" class="headerlink" title="K8S init (controller)"></a>K8S init (controller)</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo kubeadm init --pod-network-cidr=[CNI required range] --apiserver-advertise-address=[local IP address]</span><br><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>

<p><code>--pod-network-cidr</code>:</p>
<ul>
<li>flannel: <code>10.244.0.0/16</code></li>
<li>weave: <code>10.32.0.0/12</code></li>
<li>calico: <code>192.168.0.0/16</code></li>
</ul>
<p>apply CNI</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># flannel</span><br><span class="line">kubectl apply -f &lt;https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml&gt;</span><br><span class="line"></span><br><span class="line"># weave</span><br><span class="line">kubectl apply -f &quot;https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d &#x27;\n&#x27;)&quot;</span><br><span class="line"></span><br><span class="line"># calico</span><br><span class="line">kubectl apply -f https://docs.projectcalico.org/manifests/calico-typha.yaml</span><br></pre></td></tr></table></figure>

<h2 id="K8S-join-nodes"><a href="#K8S-join-nodes" class="headerlink" title="K8S join (nodes)"></a>K8S join (nodes)</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo kubeadm join 10.0.0.145:6443 --token rehcz9.67jf80xbe86oj9j1 \\</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:c4275404b872ce55ccb2a9e7df48a9b8d40010c1bc35e4ec19278a449de9bad5</span><br></pre></td></tr></table></figure>

<h2 id="deployement-yml"><a href="#deployement-yml" class="headerlink" title="deployement.yml"></a>deployement.yml</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl apply -f deployement.yml</span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: [this is a name]-deployment</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: [this is a name]</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: [this is a name]</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: [this is a name]</span><br><span class="line">        image: [this is docker image]</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: &quot;0.5&quot;</span><br><span class="line">            memory: &quot;512Mi&quot;</span><br><span class="line">          requests:</span><br><span class="line">            cpu: &quot;0.5&quot;</span><br><span class="line">            memory: &quot;512Mi&quot;</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 5000</span><br></pre></td></tr></table></figure>

<h2 id="service-yml"><a href="#service-yml" class="headerlink" title="service.yml"></a>service.yml</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl apply -f service.yml</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: [this is a name]-service</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    app: [this is a name]</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 5000</span><br><span class="line">    targetPort: 5000</span><br><span class="line">    nodePort: 30007</span><br></pre></td></tr></table></figure>

<h2 id="Check-Docker-and-Kubelet-Status"><a href="#Check-Docker-and-Kubelet-Status" class="headerlink" title="Check Docker and Kubelet Status"></a>Check Docker and Kubelet Status</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo systemctl status docker</span><br><span class="line">sudo systemctl status kubelet</span><br></pre></td></tr></table></figure>

<h2 id="Monitor-K8S-Resources"><a href="#Monitor-K8S-Resources" class="headerlink" title="Monitor K8S Resources"></a>Monitor K8S Resources</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">watch kubectl get deployment,svc,pods,nodes -o wide --all-namespaces</span><br></pre></td></tr></table></figure>

<h1 id="Command-to-Revert"><a href="#Command-to-Revert" class="headerlink" title="Command to Revert"></a>Command to Revert</h1><h2 id="K8S"><a href="#K8S" class="headerlink" title="K8S"></a>K8S</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo kubeadm reset</span><br><span class="line">sudo apt-get purge kubeadm kubectl kubelet kubernetes-cni kube*   </span><br><span class="line">sudo apt-get autoremove  </span><br><span class="line">sudo rm -rf ~/.kube</span><br><span class="line">sudo rm -rf /etc/kubernetes</span><br><span class="line">sudo rm -rf /etc/cni/net.d</span><br><span class="line">sudo rm -rf /var/lib/kubelet</span><br><span class="line">sudo rm -rf /var/lib/etcd</span><br></pre></td></tr></table></figure>

<h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo docker system prune -a</span><br><span class="line">sudo apt remove docker.io</span><br><span class="line">sudo apt autoremove</span><br></pre></td></tr></table></figure>

<h1 id="Pitfalls"><a href="#Pitfalls" class="headerlink" title="!!! Pitfalls !!!"></a>!!! Pitfalls !!!</h1><ol>
<li><p><strong>Everything is well configured; I can <code>curl localhost:30033</code> from nodes or <code>curl [node_ip]:30033</code> from the controller, but not <code>curl localhost:30033</code> from the controller.</strong></p>
<p>This is because the iptables and security lists block the communication between <code>kube-proxies</code>. Refers to the Pre-Configuration part.</p>
</li>
<li><p><strong>Timeout while joining controller from nodes.</strong></p>
<p>This is highly due to improper configurations on security lists. We have to open TCP port 6443 for both ways.</p>
</li>
<li><p><strong>Pods show <code>running</code>, but the <code>READY</code> state is <code>0/1</code> for the DNS pod.</strong></p>
<p>This happens when I first implement flannel as my OCI, I finally figured out this issue is also related to iptables. The traffics are DROPPED by rules.</p>
</li>
<li><p><strong><code>dial tcp 127.0.0.1:10248: connect: connection refused</code> when I run <code>kubeadm init</code>.</strong></p>
<p>This is because Docker <code>cgroup</code> is not <code>systemd</code>.</p>
</li>
<li><p><strong><code>failed to get config map: Unauthorised</code> while joining nodes to the controller.</strong></p>
<p>The token is invalid, run <code>sudo kubeadm token create --print-join-command</code> on the controller to create a new one.</p>
</li>
<li><p><strong><code>Port 10250 is in use</code></strong></p>
<p>This is because <code>kubelet</code> is using this port, run <code>sudo systemctl restart kubelet</code> or <code>sudo kubeadm reset</code></p>
</li>
</ol>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ol>
<li><a target="_blank" rel="noopener" href="https://faun.pub/free-ha-multi-architecture-kubernetes-cluster-from-oracle-c66b8ce7cc37">https://faun.pub/free-ha-multi-architecture-kubernetes-cluster-from-oracle-c66b8ce7cc37</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/platformer-blog/running-a-kubernetes-cluster-on-ubuntu-with-calico-9e372fb9175e">https://medium.com/platformer-blog/running-a-kubernetes-cluster-on-ubuntu-with-calico-9e372fb9175e</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/flannel-io/flannel">https://github.com/flannel-io/flannel</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/a/60725618">https://stackoverflow.com/a/60725618</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/ports-and-protocols/">https://kubernetes.io/docs/reference/ports-and-protocols/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/service/">https://kubernetes.io/docs/concepts/services-networking/service/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/">https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/dockerd/">https://docs.docker.com/engine/reference/commandline/dockerd/</a></li>
<li><a target="_blank" rel="noopener" href="http://www.dest-unreach.org/socat/doc/socat.html#EXAMPLES">http://www.dest-unreach.org/socat/doc/socat.html#EXAMPLES</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/haveanybody/article/details/86494063">https://blog.csdn.net/haveanybody/article/details/86494063</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/a/58491408">https://stackoverflow.com/a/58491408</a></li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://wudiaries.com">Mr.Kelvin</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://wudiaries.com/2022/04/27/Implementing-Kubernetes-and-Docker-on-OCI/">https://wudiaries.com/2022/04/27/Implementing-Kubernetes-and-Docker-on-OCI/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/OCI/">OCI</a><a class="post-meta__tags" href="/tags/Docker/">Docker</a><a class="post-meta__tags" href="/tags/Kubernetes/">Kubernetes</a><a class="post-meta__tags" href="/tags/NodePort/">NodePort</a></div><div class="post_share"><div class="social-share" data-image="https://hcljapan.co.jp/software/blog/bl-content/uploads/pages/8d736f3963252b65f6c5b49336c4f217/Untitled-1.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/statics/images/avatar.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Mr.Kelvin</div><div class="author-info__description">Think Like an Artist, Do Like an Artisan!</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">2</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">2</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ikelvinwoo"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/ikelvinwoo" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:ikelvinwoo@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">俗人昭昭,我独昏昏；俗人察察,我独闷闷。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pre-Configuration"><span class="toc-number">2.</span> <span class="toc-text">Pre-Configuration</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#iptables-controller-amp-nodes"><span class="toc-number">2.1.</span> <span class="toc-text">iptables (controller &amp; nodes)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Security-Lists"><span class="toc-number">2.2.</span> <span class="toc-text">Security Lists</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Configuration"><span class="toc-number">3.</span> <span class="toc-text">Configuration</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#System-updates-controller-amp-nodes"><span class="toc-number">3.1.</span> <span class="toc-text">System updates (controller &amp; nodes)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker-controller-amp-nodes"><span class="toc-number">3.2.</span> <span class="toc-text">Docker (controller &amp; nodes)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#K8S-Installation-controller-amp-nodes"><span class="toc-number">3.3.</span> <span class="toc-text">K8S Installation (controller &amp; nodes)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Post-Configuration"><span class="toc-number">4.</span> <span class="toc-text">Post-Configuration</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#K8S-init-controller"><span class="toc-number">4.1.</span> <span class="toc-text">K8S init (controller)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#K8S-join-nodes"><span class="toc-number">4.2.</span> <span class="toc-text">K8S join (nodes)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#deployement-yml"><span class="toc-number">4.3.</span> <span class="toc-text">deployement.yml</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#service-yml"><span class="toc-number">4.4.</span> <span class="toc-text">service.yml</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Check-Docker-and-Kubelet-Status"><span class="toc-number">4.5.</span> <span class="toc-text">Check Docker and Kubelet Status</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Monitor-K8S-Resources"><span class="toc-number">4.6.</span> <span class="toc-text">Monitor K8S Resources</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Command-to-Revert"><span class="toc-number">5.</span> <span class="toc-text">Command to Revert</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#K8S"><span class="toc-number">5.1.</span> <span class="toc-text">K8S</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker"><span class="toc-number">5.2.</span> <span class="toc-text">Docker</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pitfalls"><span class="toc-number">6.</span> <span class="toc-text">!!! Pitfalls !!!</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#References"><span class="toc-number">7.</span> <span class="toc-text">References</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/04/27/Implementing-Kubernetes-and-Docker-on-OCI/" title="Implementing Kubernetes and Docker on OCI"><img src="https://hcljapan.co.jp/software/blog/bl-content/uploads/pages/8d736f3963252b65f6c5b49336c4f217/Untitled-1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Implementing Kubernetes and Docker on OCI"/></a><div class="content"><a class="title" href="/2022/04/27/Implementing-Kubernetes-and-Docker-on-OCI/" title="Implementing Kubernetes and Docker on OCI">Implementing Kubernetes and Docker on OCI</a><time datetime="2022-04-27T00:34:37.000Z" title="Created 04-27-2022 10:34:37">04-27-2022</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/08/21/Port-Scanning/" title="Port Scanning"><img src="https://info.varonis.com/hubfs/Imported_Blog_Media/port-scan-hero.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Port Scanning"/></a><div class="content"><a class="title" href="/2021/08/21/Port-Scanning/" title="Port Scanning">Port Scanning</a><time datetime="2021-08-21T00:15:00.000Z" title="Created 08-21-2021 10:15:00">08-21-2021</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://hcljapan.co.jp/software/blog/bl-content/uploads/pages/8d736f3963252b65f6c5b49336c4f217/Untitled-1.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By Mr.Kelvin</div><div class="footer_custom_text">Think Like an Artist, Do Like an Artisan!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>